<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Facturas</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
<h2>üßæ Gesti√≥n de Facturas</h2>
<a th:href="@{/}">‚¨Ö Volver al inicio</a>
<hr>

<div th:if="${error}" style="color: red; background-color: #ffe6e6; padding: 10px; margin: 10px 0; border: 1px solid red;">
    <strong>Error:</strong> <span th:text="${error}"></span>
</div>

<h3 th:text="${editMode ? 'Editar Factura' : 'Nueva Factura'}"></h3>
<form th:if="${editMode == null or !editMode}" th:action="@{/facturas}" method="post">
    <label for="paciente">Paciente:</label>
    <select id="paciente" name="paciente.idPaciente" required>
        <option value="">-- Selecciona Paciente --</option>
        <option th:each="p : ${pacientes}"
                th:value="${p.idPaciente}"
                th:text="${p.nombres + ' ' + p.apellidos + ' (' + p.dni + ')'}">
        </option>
    </select><br>

    <label for="fechaEmision">Fecha de Emisi√≥n:</label>
    <input type="date" id="fechaEmision" name="fechaEmision" required><br>

    <label for="total">Total:</label>
    <input type="number" id="total" name="total" step="0.01" required><br>

    <label for="estado">Estado:</label>
    <select id="estado" name="estado" required>
        <option value="">-- Selecciona Estado --</option>
        <option value="PENDIENTE">Pendiente</option>
        <option value="PAGADO">Pagado</option>
    </select><br>

    <button type="submit">Guardar Factura</button>
</form>

<form th:if="${editMode}" th:action="@{/facturas/{id}/actualizar(id=${factura.idFactura})}" method="post">
    <input type="hidden" name="idFactura" th:value="${factura.idFactura}">
    <label for="pacienteEdit">Paciente:</label>
    <select id="pacienteEdit" name="paciente.idPaciente" required>
        <option value="">-- Selecciona Paciente --</option>
        <option th:each="p : ${pacientes}"
                th:value="${p.idPaciente}"
                th:text="${p.nombres + ' ' + p.apellidos + ' (' + p.dni + ')'}"
                th:selected="${factura.paciente != null and factura.paciente.idPaciente == p.idPaciente}">
        </option>
    </select><br>

    <label for="fechaEmisionEdit">Fecha de Emisi√≥n:</label>
    <input type="date" id="fechaEmisionEdit" name="fechaEmision" th:value="${factura.fechaEmision}" required><br>

    <label for="totalEdit">Total:</label>
    <input type="number" id="totalEdit" name="total" step="0.01" th:value="${factura.total}" required><br>

    <label for="estadoEdit">Estado:</label>
    <select id="estadoEdit" name="estado" required>
        <option value="">-- Selecciona Estado --</option>
        <option value="PENDIENTE" th:selected="${factura.estado.name() == 'PENDIENTE'}">Pendiente</option>
        <option value="PAGADO" th:selected="${factura.estado.name() == 'PAGADO'}">Pagado</option>
    </select><br>

    <button type="submit">Actualizar Factura</button>
    <a th:href="@{/facturas}">Cancelar</a>
</form>

<hr>

<h3>Lista de Facturas</h3>
<table border="1">
    <thead>
    <tr>
        <th>ID</th>
        <th>Paciente</th>
        <th>Fecha Emisi√≥n</th>
        <th>Total</th>
        <th>Estado</th>
        <th>Acciones</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="f : ${facturas}">
        <td th:text="${f.idFactura}"></td>
        <td th:text="${f.paciente.nombres + ' ' + f.paciente.apellidos}"></td>
        <td th:text="${f.fechaEmision}"></td>
        <td th:text="${f.total}"></td>
        <td>
            <span th:style="${f.estado.name() == 'PENDIENTE' ? 'color: orange;' : 'color: green;'}"
                  th:text="${f.estado.descripcion}"></span>
        </td>
        <td>
            <a th:href="@{'/facturas/' + ${f.idFactura} + '/editar'}">Editar</a> |
            <a th:href="@{'/facturas/' + ${f.idFactura} + '/delete'}" onclick="return confirm('¬øEst√°s seguro de eliminar esta factura?');">Eliminar</a> |
            <a th:href="@{'/detalle-facturas?facturaId=' + ${f.idFactura}}">Ver Detalles</a>
        </td>
    </tr>
    </tbody>
</table>

</body>
</html>